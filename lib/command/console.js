// Generated by CoffeeScript 1.12.5
(function() {
  var CommandConsole, commander, cormo_console, fs, net, requireNoCache, resolve;

  commander = require('commander');

  cormo_console = require('../util/console');

  fs = require('fs');

  resolve = require('path').resolve;

  net = require('net');

  requireNoCache = function(path) {
    delete require.cache[require.resolve(path)];
    return require(path);
  };

  CommandConsole = (function() {
    function CommandConsole(argv) {
      var cwd, e, i, len, load, loads, path, program;
      loads = [];
      program = new commander.Command('cormo');
      program.usage('console [options]').option('-l, --load <path>', 'load specified module').option('-d, --inspect-depth <depth>', 'specify depth for util.inspect').option('-s, --serve <port>', 'serve console at port').option('--javascript', 'using JavaScript instead of CoffeeScript').on('load', function(path) {
        return loads.push(path);
      }).on('inspect-depth', (function(_this) {
        return function(depth) {
          return _this.inspect_depth = depth;
        };
      })(this)).on('serve', (function(_this) {
        return function(port) {
          return _this.serve_port = port;
        };
      })(this)).on('javascript', (function(_this) {
        return function() {
          return _this.language = 'javascript';
        };
      })(this));
      if (argv.indexOf('--help') >= 0 || argv.indexOf('-h') >= 0) {
        program.help();
      }
      program.parse(argv);
      require('coffee-script/register');
      this.watch_files = [];
      cwd = process.cwd();
      for (i = 0, len = loads.length; i < len; i++) {
        load = loads[i];
        console.log("Loading module '" + load + "'...");
        try {
          path = resolve(cwd, load);
          require(path);
          this.watch_files.push(path);
        } catch (error) {
          e = error;
          if (e.code === 'MODULE_NOT_FOUND' && RegExp("'" + path + "'$").test(e.message)) {
            try {
              require(load);
            } catch (error) {
              e = error;
              console.log(e.toString());
            }
          } else {
            console.log(e.toString());
          }
        }
      }
    }

    CommandConsole.prototype.run = function() {
      var file, fn, i, len, ref;
      this.startConsole(this.language === 'javascript' ? 'JS' : 'Coffee');
      ref = this.watch_files;
      fn = function(file) {
        return fs.watchFile(file, function() {
          var e;
          console.log("Reloading module '" + file + "'...");
          try {
            requireNoCache(file);
          } catch (error) {
            e = error;
            console.log(e.toString());
          }
          return cormo_console.resetupContext();
        });
      };
      for (i = 0, len = ref.length; i < len; i++) {
        file = ref[i];
        fn(file);
      }
    };

    CommandConsole.prototype.startConsole = function(type) {
      var server;
      if (this.serve_port) {
        server = net.createServer((function(_this) {
          return function(socket) {
            return cormo_console['start' + type]({
              inspect_depth: _this.inspect_depth,
              socket: socket
            }).on('exit', function() {
              return socket.end();
            });
          };
        })(this)).listen(this.serve_port);
      }
      return cormo_console['start' + type]({
        inspect_depth: this.inspect_depth
      }).on('exit', function() {
        return process.exit(0);
      });
    };

    return CommandConsole;

  })();

  module.exports = CommandConsole;

}).call(this);
